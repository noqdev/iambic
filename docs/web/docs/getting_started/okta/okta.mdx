---
title: Okta
---

Configure Okta

In this tutorial, you will configure IAMbic for an Okta Organization. 
By the end of this tutorial, you will have performed the following steps:

1. Create a basic Okta configuration for Iambic
2. Import existing Okta Groups
3. Create an Okta Group
4. Add a user to the group
5. Provide temporary ("break-glass") access to a Google Group
6. (TODO do we want to expire the group also?)

<!-- TODO This looks incomplete, but I assume it should mirror the google groups setup, mostly
As with the google page, these headings should link to, and match, headings below
 -->

## Prerequisities

You will need administrative access to an existing Okta organization. If you do not have one, you can
create a developer organization at [developer.okta.com](https://developer.okta.com/).

* Set the following environment variables in the terminal you will be using to run Iambic commands.
  These are only needed for the duration of this tutorial. They are not required for the normal usage of Iambic:
<!-- we probably want copy icons here  -->


```bash
export EMAIL=<your_okta_email_address>
export OKTA_DOMAIN=<your_okta_domain> # ex: https://dev-12345.okta.com/
export OKTA_ORG_NAME=<your_okta_org_name> # ex: development. This is a friendly name to identify your Okta organization
export OKTA_API_TOKEN=<your_okta_api_token> # An administrative API token for your Okta organization, follow the instructions in the following steps to create one.
```

## 1. Create a basic Okta configuration for Iambic

First, you'll need to create an API token that allows Okta to manage group memberships by
signing in to Okta and following these steps:

1. Click on Security
2. Click on API
3. Click on Tokens
4. Click on "Create Token"
5. Create a token for Iambic. This token will be used to authenticate
   Iambic with Okta.
6. Copy the value of the token.


<details>
  <summary>Screenshot</summary>

![Okta-token](/img/okta/okta-token-1.png)

</details>

With your token in hand, create `config/secrets.yaml`
in your `iambic-templates` Git repo if it doesn't already exist:

:::danger

Never commit secrets Git. Ensure that you have a  `.gitignore` file in the root directory of your `iambic-templates` repository that
is configured to ignore secrets.yaml files with `**/secrets.yaml`. Learn more about `.gitignore` files [here](https://git-scm.com/docs/gitignore).

:::


```bash
cat <<EOF > config/secrets.yaml
secrets:
  okta:
    - idp_name: $OKTA_ORG_NAME
      org_url: $OKTA_DOMAIN
      api_token: $OKTA_API_TOKEN
EOF
```


From the base directory of your IAMbic templates repository, your directory structure should resemble the following. You may
have more files if you've recently imported your cloud resources.

```bash
tree .
.
├── config
│   ├── config.yaml
│   └── secrets.yaml
```

## 2. Import existing Okta Groups


In this section, you will manually import existing Okta Groups into your IAMbic templates repository.
In a production environment, automation provided by Iambic would ensure that Git is updated with the
cloud resources in your production environment. This allows you to monitor the history of
these groups via Git History.

Run the following command in the root of your `iambic-templates` repository to import your existing Okta Groups:

```bash
iambic import
```

If you have Okta Groups defined, your iambic-templates repository should have a `okta/groups` directory with a
subdirectory for each Okta organization you have defined.

## 3. Create an Okta Group

Iambic uses a YAML file to describe the desired state of a Google Group. In this section, we will create a group called
`iambic-test-group` in your domain. Ensure that the environment variables you've set previously are still configured,
and also ensure that your credentials are working properly by running the import process from the previous section.

Run the following set of commands from the root of your `iambic-templates` repository to create a new Google Group template:

```bash
mkdir -p okta/groups/$OKTA_ORG_NAME
cat <<EOF > okta/groups/$OKTA_ORG_NAME/iambic-test-group.yaml
template_type: NOQ::Okta::Group
properties:
  name: iambic-test-group
  description: ''
  idp_name: development
  members:
    - username: $EMAIL
EOF
```

Apply the template to your Okta Organization by running the following command:

:::info

In a production environment, this would be handled by a command issued on a Github Pull Request after the appropriate approvals have been made.

:::

```bash
iambic apply -t okta/groups/$OKTA_ORG_NAME/iambic-test-group.yaml
```

Confirm that the group has been created by running the following in your terminal, and visiting the URL in your browser:

```bash
echo https://$OKTA_DOMAIN/admin/groups
```

By now the directory of your `iambic-templates` repository should resemble the following,
and may include other resources that you've imported:

```bash
$ tree .
.
├── config
│   ├── config.yaml
│   └── secrets.yaml
├── okta
│   └── groups
│       └── $OKTA_DOMAIN
│           ├── iambic-test-group.yaml
```

## 4. Add a user to the group

In this section, we will add your user to the group we created in the previous section.

Run the following command to replace the previous group you created with a new one that includes the new user:

```bash
cat <<EOF > google/groups/$DOMAIN/iambic-test-group.yaml
template_type: NOQ::Google::Group
properties:
  name: iambic-test-group
  description: ''
  domain: $DOMAIN
  email: iambic-test-group@$DOMAIN
  members:
    - email: $EMAIL
      role: OWNER
    - email: fakeuser@example.com
EOF
```

```bash
cat <<EOF > okta/groups/$OKTA_ORG_NAME/iambic-test-group.yaml
template_type: NOQ::Okta::Group
properties:
  name: iambic-test-group
  description: ''
  idp_name: development
  members:
    - username: $EMAIL
EOF
```

Run the `apply` command again to update the group:

```bash
iambic apply -t google/groups/$DOMAIN/iambic-test-group.yaml
```

## 5. Provide temporary ("break-glass") access to a Google Group

In this section, we will update the group membership added in the previous section
to configure the access to expire in two minutes, simulating a very short breakglass request.
In order to facilitate this request,
we will add an expiration date to the user's membership in the group. Run the following command to replace the previous group you
created with a new one that includes the additional user and an expiration date:

:::tip

If a specific expiration date is provided without a timezone, Iambic will assume the timezone is UTC.
If a timezone is provided, Iambic will use that timezone.

:::

```bash
cat <<EOF > okta/groups/$OKTA_ORG_NAME/iambic-test-group.yaml
template_type: NOQ::Okta::Group
properties:
  name: iambic-test-group
  description: ''
  idp_name: development
  members:
    - username: $EMAIL
      expires_at: in 2 minutes
EOF
```

```bash
iambic apply -t okta/groups/$OKTA_ORG_NAME/iambic-test-group.yaml
```

After applying the change, notice that the `expires_at` date in the template was converted from a relative expiration time ("in two minutes")
to an absolute date (Example: "2021-05-20T15:00:00-04:00"). This allows Iambic to know exactly when the request should be expired.

Confirm that the user was added by visiting the following URL in your browser:

```bash
echo https://$OKTA_DOMAIN/admin/groups
```

After a couple of minutes, the request should expire. In a production deployment, this process would be automatic. But for the purposes
of testing, you can manually expire the request by re-running the apply command:

```bash
iambic apply -t okta/groups/$OKTA_ORG_NAME/iambic-test-group.yaml
```