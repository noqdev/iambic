Overview

Github integration is designed for team collaboration on iambic templates. A typical workflow would be the following:

1. Developer Alice submits a pull request to iambic templates to create an application role.
2. Upon the PR is created, iambic github action will run "iambic git-plan" to preview what is the impact of the PR and submits the proposed_changes.yaml back into the PR as comment.
3. Reviewer Bob will review the templates change along with the proposed_changes. Reviewer Bob may request additional changes.
4. Developer Alice updates the PR and iambic github action again run "iambic git-plan" to calculate changes_required.
5. Reviewer Bob approved the PR.
6. Developer Alice submits an  "iambic git-apply" comment in the PR.
7. IAMbic github action will apply the changes in the PR. Upon git-apply is successful, the pull request is closed by the github action.

Pre-requisite

1. You have run the iambic tutorial to import your own environment in a local repository.
2. Github repository for iambic templates.
3. An admin for this Github repository to perform the following action
3a. configure repository to require approvals before merging PR
3b. create fine grain access token to allow automatic import
4. An AWS admin to configure federated login by iambic github actions

Configure Github Repository require Approvals before merging

1. Assuming this repository is called "noqdev/iambic-templates-example" where "noqdev" is the Github organization and "iambic-templates-example" is the short repository name within "noqdev" Github organization.
2. Visit https://github.com/noqdev/iambic-templates-example/settings/branches
3. Add branch protection rule
4. For Branch name pattern, use `main`
5. Check "Require a pull request before merging", and ensure "Require Approvals" is checked. Leave the default for "required number of approvals before merging"
6. Check "Require status checks to pass before merging"

Configure Access token for Github Action to update repository periodically.

1. Visit https://github.com/settings/apps
2. Select Personal access tokens
3. Select Fine-grain tokens
4. Select Generate new token
5. For token name, input "iambic-templates-import"
5a. For expiration, select custom, select a date that is one year from now. (Tip: use your organization preferred token valid length).
5b. For Resource owner, select the Github organization that Github repository belongs to.
5c. For Repository Access, select "Only select repositories", then click on "Select Repositories". In this tutorial, we select "noqdev/iambic-templates-example". You should use the repository name that you create for your Github organization.
5d. Click on Repository permissions, Give "Access: Read and Write" for "Contents". (Tip: this allows the github action for import to push to the repository without approval. The intend is human changes require approval flow and auto import flow that inventory the cloud resources does not require approval flow.)
5e. No action is needed, but you will notice previous action will automatically select "Access: Read" for "Metadata"
5f. Click "Generate Token".
6. If your organization has a password vault, you can optionally store it in your organization password vault. Otherwise, move to next step to allow the repository to use the newly generated token.
7. Open a new tab and visit https://github.com/noqdev/iambic-templates-example/settings/environments. (Tip: you should modify the link to go your own repository)
8. Add new environment
9. For name, type in `production`
10. Click `Configure environment`
11. Change Deployment branches to `Selected Branches`
12. Add Deployment Branch Rule, type in `main` for Branch name pattern. Click Add Rule
13. Click Add Secret
14. For Name, input "AUTO_IMPORT_GH_TOKEN"
15. For Secret, paste in the token generated in step 5f.

Configure Access token for Github Action to automatically comment on new/edit pull request for iambic planning and application.

1. Visit https://github.com/settings/apps
2. Select Personal access tokens
3. Select Fine-grain tokens
4. Select Generate new token
5. For token name, input "iambic-templates-comment"
5a. For expiration, select custom, select a date that is one year from now. (Tip: use your organization preferred token valid length).
5b. For Resource owner, select the Github organization that Github repository belongs to.
5c. For Repository Access, select "Only select repositories", then click on "Select Repositories". In this tutorial, we select "noqdev/iambic-templates-example". You should use the repository name that you create for your Github organization.
5d. Click on Repository permissions, Give "Pull Request: Read and Write" for "Contents". (Tip: this allows the github action for comment on pull requests. The intend is the main branch can watch for any pull request comment to automatically plan the changes.)
5e. No action is needed, but you will notice previous action will automatically select "Access: Read" for "Metadata"
5f. Click "Generate Token".
6. If your organization has a password vault, you can optionally store it in your organization password vault. Otherwise, move to next step to allow the repository to use the newly generated token.
7. Open a new tab and visit https://github.com/noqdev/iambic-templates-example/settings/secrets/actions. (Tip: you should modify the link to go your own repository)
8. Click Add New Repository Secret
9. For Name, input "AUTO_IMPORT_GH_TOKEN"
10. For Secret, paste in the token generated in step 5f.

Configure Variable for Github Action to target the right AWS account

1. Visit https://github.com/noqdev/iambic-templates-example/settings/variables/actions (Tip change the repo name to reflect to your organization and repo)
2. Click "New repository variable"
3. For name, input "AWS_ACCOUNT_WITH_HUB_ROLE"
4. For value, input the AWS account number where you install the IambicHubRole, for example, it maybe 123456789012
5. For name, input "AWS_ACCOUNT_WITH_SECRETS"
6. For value, input the AWS account number where you store the secrets to be used for IAMbic., for example, it maybe 234567890123

Configure IambicHubRole AWS account to federated login for Github actions

1. Log into the AWS Console using the account.
2. Visit https://us-east-1.console.aws.amazon.com/iamv2/home?region=us-west-2#/identity_providers
3. Select OpenID Connect
4. For Provider name, input `https://token.actions.githubusercontent.com`
5. Click Get Thumbprint
6. For Audience, input `sts.amazonaws.com`
7. Click Add provider

Configure IambicHubRole AWS account to allow AssumeRoleWithWebIdentity

1. We need to add a statement in IambicHubRole assume role policy to allow github action to autenticate and assume the IambicHubRole.

Add the following statement into the Allow statement block
```
		{
			"Effect": "Allow",
			"Principal": {
				"Federated": "arn:aws:iam::REPLACE_WITH_YOUR_AWS_ACCOUNT_ID:oidc-provider/token.actions.githubusercontent.com"
			},
			"Action": "sts:AssumeRoleWithWebIdentity",
			"Condition": {
				"StringLike": {
					"token.actions.githubusercontent.com:sub": [
                        "repo:REPLACE_WITH_YOUR_GITHUB_ORG/REPLACE_WITH_YOUR_GITHUB_REPOSITORY_NAME:ref:refs/heads/main",
                        "repo:REPLACE_WITH_YOUR_GITHUB_ORG/REPLACE_WITH_YOUR_GITHUB_REPOSITORY_NAME:environment:production"
                    ]
				},
				"ForAllValues:StringEquals": {
					"token.actions.githubusercontent.com:aud": "sts.amazonaws.com",
					"token.actions.githubusercontent.com:iss": "https://token.actions.githubusercontent.com"
				}
			}
		}
```

Install the iambic github actions to iambic-templates repo

1. Copy the following .github/workflows folder into your template directory
2. mkdir -p ~/github
3. git clone https://github.com/noqdev/iambic-templates-example/ iambic-templates-example
4. git clone <YOUR OWN IAMBIC repo> iambic-templates
5. cd iambic-templates
6. git checkout -b task/install_gh_actions origin/main
7. cp -R ../iambic-templates-example/.github .
8. git add .github
9. git commit -m "Install github actions"
10. git push origin HEAD
11. Review the pull request in your repository and merge the pull request.

Open a pull request on your iambic-template repo

1. git checkout -b task/change_description origin/main
2. Edit one of your templates change_description
3. git push origin HEAD
4. Create a pull request.
5. The installed pull request action will comment with "iambic git-plan" to place the changes. At any time, you want iambic github action to re-plan the changes, you can comment "iambic git-plan"
6. The plan will be comment in line (as long as it is less than 65kilobytes. Be very careful with big plan because those are difficult for reviewers to review.)
7. Add reviewers to review your PR and plan that is in the PR comments.
8. Once your reviewer approve your changes. Add comment "iambic git-apply" to have iambic apply the changes. If the changes can be successfully applied, the PR will be automatically merged into main as well.

FAQ

1. The git-plan and git-apply process are performed via merge workflow. main branch is first checked out and then merge the changes requested in the PR. This is to ensure the plan is as up-to-date as possible. At any time if there is conflict, the requester should pull origin/main into the PR branch and allow iambic github action to replan the changes.